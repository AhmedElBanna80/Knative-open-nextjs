# The Operator Reconciler

The Reconciler (located at `internal/controller/nextapp_controller.go`) is the core engine of the `kn-next-operator`. It continuously monitors the state of `NextApp` Custom Resources and ensures the Kubernetes cluster matches the declared `Spec`.

## How It Works

The reconciliation loop triggers on creation, updates, and deletion of `NextApp` resources. It orchestrates the lifecycle of four distinct Kubernetes sub-resources in a strict dependency order:

### 1. Service Account (`ServiceAccount`)
The operator generates a dedicated, least-privilege `ServiceAccount` for the application (e.g., `[app-name]-sa`).
- **Security Check**: It explicitly sets `AutomountServiceAccountToken = false` to prevent arbitrary pods from accessing the Kubernetes API, adhering to secure-by-default container posture.

### 2. Bytecode Cache Storage (`PersistentVolumeClaim`)
If `spec.cache.enableBytecodeCache` is `true`, the operator dynamically provisions a ReadWriteOnce `PersistentVolumeClaim`.
- This PVC is sized based on `bytecodeCacheSize` (defaulting to `512Mi`).
- It allows subsequent pod replicas to skip V8 JS parsing and compilation, accelerating pod startup times.

### 3. Asynchronous ISR Binding (`KafkaSource`)
If `spec.revalidation.queue` is configured for Kafka, the Reconciler binds the active Knative Service to a Knative Eventing `KafkaSource`.
- This enables robust, asynchronous Incremental Static Regeneration (ISR) loops entirely detached from the user's critical request path.
- See [Kafka Eventing](./kafka-eventing.md) for deeper details.

### 4. Application Server (`serving.knative.dev/v1 Service`)
The core routing and application logic. The Reconciler translates the `NextApp` CRD into a Knative Service:
- **Annotations**: Maps the `scaling` properties directly to Knative autoscaling annotations (`min-scale`, `max-scale`).
- **Environment**: Orchestrates the Redis Cache, Storage boundaries, and Kafka locations natively into container `EnvVars`.
- **Security**: Injects user-defined `Secret` references as `EnvFromSource`.
- **Volumes**: Mounts the dynamically generated bytecode PVC to `/cache/bytecode`.
- **Probes**: Configures HTTP deep-health readiness/liveness probes at `/api/health`.

## Status Updates
If the Knative Service initializes successfully, the gateway provisions a routing domain. The Reconciler monitors this process and surfaces the final live URL immediately back into the `NextApp` resource Status block (`status.url`).
